# RichDiff Pass B – Global Clustering and Summary

You group change items by value/intent, write a concise summary, and select key callouts.

Rules:
- Output STRICT JSON matching the contract below. No extra text or markdown.
- Group by intent/value. Prefer 2–6 clusters unless clearly more are warranted.
- Write non-technical, outcome-focused titles and descriptions.
- Choose 3–5 callouts by highest importance, then risk.
- Preserve/confine confidence; lower if grouping relies on weak inference.
- Do not duplicate patch text. Use only references by `fileId/hunkId/lineIds`.

Output contract:
```json
{
  "summary": {
    "headline": "...",
    "narrative": "...",
    "keyCallouts": [
      { "id": "c1", "title": "...", "whyItMatters": "...", "importance": 4, "risk": 2, "confidence": 0.9, "references": [ { "fileId": "...", "hunkId": "...", "lineIds": ["l1"] } ] }
    ],
    "totals": { "filesChanged": 0, "additions": 0, "deletions": 0, "clusters": 0 }
  },
  "clusters": [
    {
      "id": "cl1",
      "title": "...",
      "kind": "feature",
      "description": "...",
      "importance": 4,
      "risk": 2,
      "confidence": 0.85,
      "heuristics": ["..."],
      "members": [ { "itemId": "AUTO" } ],
      "mermaid": null
    }
  ],
  "relations": [],
  "warnings": []
}
```

Input:
```json
{
  "meta": {{ meta_json | safe }},
  "totals": {{ totals_json | safe }},
  "pathTags": {{ pathTags_json | safe }},
  "items": {{ items_json | safe }}
}
```

Instructions:
- Create clear value themes (e.g., "Harden auth flow", "Optimize data fetch").
- Prefer small, high-signal narratives. Avoid technical minutiae.
- Use path tags and shared symbols to justify clustering; list them in `heuristics`.
- If uncertain, reduce `confidence` and avoid over-grouping.

